name: Integration test

on:
  push:
    branches:
    - '**'

jobs:
  integration_test:
    timeout-minutes: 45
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - uses: cachix/install-nix-action@v13
      with:
        nix_path: nixpkgs=https://github.com/NixOS/nixpkgs/archive/8e4fe32876ca15e3d5eb3ecd3ca0b224417f5f17.tar.gz

    - name: Install dependencies
      run: nix-env -if tests/default.nix

    - name: Start cluster
      run: |-
        # - --k3s-server-arg args according to
        #   https://k3d.io/faq/faq/#solved-nodes-fail-to-start-or-get-stuck-in-notready-state-with-log-nf_conntrack_max-permission-denied
        # - Many of these args conserve resources.. for WSO2.. sigh..
        # - We deploy our own for increased portability across k8s distributions
        k3d cluster create \
          --no-lb \
          --no-rollback \
          --k3s-server-arg "--kube-proxy-arg=conntrack-max-per-core=0" \
          --k3s-agent-arg "--kube-proxy-arg=conntrack-max-per-core=0" \
          --k3s-server-arg "--disable=traefik" \
          --k3s-server-arg "--disable=metrics-server" \
          --k3s-server-arg "--disable-cloud-controller" \
          --kubeconfig-update-default \
          --kubeconfig-switch-context \
          --image=rancher/k3s:v1.17.9-k3s1 \
          int-test

    - name: Deploy Mojaloop
      run: kustomize build 'github.com/partiallyordered/mojaloop-kustomize/base/mojaloop/central?ref=f15e5d949ca1f62a63feecbd44534e98b953a386' | kubectl apply -f -

    - name: Deploy voodoo-doll
      run: skaffold run

    - name: Wait for kube api server to process and create all resources
      # This is because the wait step that follows this one does this:
      # 1. retrieve list of pods
      # 2. wait for list of pods
      # Unfortunately, the list of pods might not be complete at step (1), as all pods may not yet
      # be created, meaning the list of pods waited on in step (2) is not complete. We therefore
      # wait some time here to allow that to finish before we retrieve the list of pods to wait on.
      # 30s should be more than enough.
      run: sleep 30s

    - name: Wait for deployment readiness
      # Skaffold is supposed to do this, but for whatever reason, does not. At the time of writing,
      # investigating this was not a priority.
      run: timeout 900 kubectl wait --for=condition=Ready pod --all --timeout=900s

    - name: Run tests
      run: cargo t --all-features

    - name: Print docker containers to check any issues with the cluster
      if: ${{ always() }}
      run: docker ps

    - name: Print voodoo doll logs
      if: ${{ always() }}
      run: kubectl logs voodoo-doll

    - name: Print resources
      if: ${{ always() }}
      run: kubectl get svc,deploy,sts,pv,pvc,configmap,job,pod -A

    - name: Describe resources
      if: ${{ always() }}
      run: kubectl describe svc,deploy,sts,pv,pvc,configmap,job,pod -A

    - name: Print secret values
      if: ${{ always() }}
      run: |-
        kubectl get secrets -o json | jq -r '.items[] | { name: .metadata.name, data: .data | map_values(@base64d) }'

    - name: Setup tmate session
      if: ${{ failure() }}
      uses: mxschmitt/action-tmate@v3
      timeout-minutes: 10
